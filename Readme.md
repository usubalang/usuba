Usuba
===
 
Usuba is a programming language to write bitsliced code. It compiles
optimized to C code (+ intrinsics).

---

## Installation

Usuba is written in OCaml and Coq. On a Debian system, you should be
able to install OCaml and Coq, as well as the required modules with:

    ./install_deps.sh

You can then compile Usuba with:

    ./configure.pl
    make

This will produce a binary named `usubac`, which you can then use to
compile Usuba programs. You can see the available options by running

    ./usubac --help


## A few examples

A few examples of Usuba codes:
 * [bitslice DES](samples/usuba/des.ua) (and the generated [C code](samples/C/des.c)),
 * [bitslice AES](samples/usuba/aes.ua) (and the generated [C code](samples/C/aes.c)),
 * [n-slice AES](samples/usuba/aes_kasper.ua) (and the generated [C code](samples/C/aes_kasper.c)),
 * [32-slice Serpent](samples/usuba/serpent.ua) (and the generated [C code](samples/C/serpent.c)),
 * [32-slice Chacha20](samples/usuba/chacha20.ua) (and the
   generated [C code](samples/C/chacha20.c)).


If you are familiar with Perl, an easy way to see the compiler an
action is to look at the scripts in the
directory [checks/correctness](checks/correctness) that compile a few
Usuba codes, run them and make sure they produce the expected results.


## Compiling

To compile an Usuba file (`.ua`), you need to be in usuba directory
(due to poor design, but it won't be the case anymore once I'll have
packaged Usuba), and then invoke `./usubac <options> <source.ua>` (the 
Usuba source file must be the last argument).  
I strongly recommand always using the flags `-no-sched -no-share
-no-arr -no-runtime` when doing pure bitslicing (it disables a few
experimental options, and reduces the amount of code loaded). The
option `-no-arr-entry` might also be usefull for small functions
(combined with `-no-arr`).
The list of flags can be obtained by running `./usubac -help`.  
For instance, to compile a bitslice AES:  
`./usubac -o aes.c -no-sched -no-arr -no-sched -no-runtime samples/usuba/aes.c`

The C code generated by Usuba uses macros to achieve genericity. This
macros are loaded with the instruction `#include "XXX.h"` at the
begining of the C files generated, where `XXX` is one of `STD`, `SSE`,
`AVX` (which should be `AVX2`), `AVX512`, `Neon`, `AltiVec`. Those
headers are located in the directory [arch](arch).



## Readings / References

The following two papers have been published about Usuba:

  * Darius Mercadier, Pierre-Evariste Dagand. [Usuba: High-Throughput and Constant-Time Ciphers, by Construction](https://dariusmercadier.com/assets/documents/usuba-pldi19.pdf), PLDI 2019.
  
  * Darius Mercadier, Pierre-Ã‰variste Dagand, Lionel Lacassagne, Gilles Muller, [Usuba, Optimizing & Trustworthy Bitslicing Compiler](https://dariusmercadier.com/assets/documents/usuba-wpmvp18.pdf), WPMVP 2018.


Some additional resources that could be useful:

  * Timeless: [One-page presentation of Usuba](https://dariusmercadier.com/assets/documents/overview-usuba.pdf)
  
  * June 2019: [Technical presentation of Usuba @PLDI'19](https://dariusmercadier.com/assets/documents/slides-pldi-jun19.pdf)
  
  * February 2019: [High-level presentation of Usuba @Inria's Junior Seminar](https://dariusmercadier.com/assets/documents/inria-junior-seminar-feb19.pdf)
